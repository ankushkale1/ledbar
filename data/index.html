<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multi-Channel PWM Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/toastify-js"
    ></script>
    <style>
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #475569;
        transition: 0.4s;
        border-radius: 34px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: #ffffff;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #10b981;
      }
      input:checked + .slider:before {
        transform: translateX(26px);
      }
      .brightness-slider,
      .scheduler-brightness-slider {
        -webkit-appearance: none;
        appearance: none;
        width: calc(100% - 100px);
        height: 8px;
        border-radius: 4px;
        background: #334155;
        outline: none;
        transition: opacity 0.2s;
      }
      .brightness-slider:hover,
      .scheduler-brightness-slider:hover {
        opacity: 1;
      }
      .brightness-slider::-webkit-slider-thumb,
      .scheduler-brightness-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        background: #3b82f6;
        cursor: pointer;
        border-radius: 50%;
        border: 2px solid #1e293b;
      }
      .brightness-slider::-moz-range-thumb,
      .scheduler-brightness-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: #3b82f6;
        cursor: pointer;
        border-radius: 50%;
        border: 2px solid #1e293b;
      }
      .brightness-slider::-webkit-slider-thumb:hover,
      .scheduler-brightness-slider::-webkit-slider-thumb:hover {
        background: #60a5fa;
      }
      .brightness-slider::-moz-range-thumb:hover,
      .scheduler-brightness-slider::-moz-range-thumb:hover {
        background: #60a5fa;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .card {
        animation: fadeIn 0.3s ease-out;
        /* Subtle 3D effect with shadow and gradient */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        background: linear-gradient(to bottom, #344155, #2a3444);
        transition: transform 0.2s ease-in-out;
      }
      .edit-icon {
        transition: all 0.2s ease;
      }
      .edit-icon:hover {
        transform: scale(1.1);
        color: #3b82f6;
      }
      button {
        transition: all 0.2s ease;
      }
      button:active {
        transform: scale(0.95);
      }
      input[type="text"]:focus,
      input[type="number"]:focus,
      input[type="time"]:focus,
      select:focus {
        transform: scale(1.01);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
    </style>
  </head>
  <body class="bg-slate-900 text-slate-200 min-h-screen p-4">
    <div class="container max-w-7xl w-full mx-auto">
      <h1
        class="text-2xl font-bold text-slate-100 border-b border-slate-700 pb-2 mb-6"
      >
        Multi-Channel PWM Controller
        <span id="version-display" class="text-sm text-gray-500 ml-2"></span>
      </h1>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div
          class="bg-slate-800 rounded-lg p-6 shadow-lg border border-slate-700"
        >
          <h2
            class="text-xl font-semibold text-slate-100 border-b border-slate-700 pb-2 mb-4"
          >
            Configuration
          </h2>
          <div class="flex justify-between items-center mb-2">
            <label for="mdns-name" class="text-slate-300">mDNS Name</label>
            <input
              type="text"
              id="mdns-name"
              class="bg-slate-700 text-slate-100 border border-slate-600 rounded p-2 focus:border-blue-500 focus:outline-none w-20 text-center"
            />
          </div>
          <div class="flex justify-between items-center">
            <label for="pin-count" class="text-slate-300">PWM Pin Count</label>
            <input
              type="number"
              id="pin-count"
              min="1"
              max="10"
              value="2"
              class="bg-slate-700 text-slate-100 border border-slate-600 rounded p-2 focus:border-blue-500 focus:outline-none w-20 text-center"
            />
          </div>
        </div>

        <div
          class="bg-slate-800 rounded-lg p-6 shadow-lg border border-slate-700"
        >
          <h2
            class="text-xl font-semibold text-slate-100 border-b border-slate-700 pb-2 mb-4"
          >
            Timezone
          </h2>
          <div class="flex flex-col gap-2">
            <label for="timezone-select" class="text-slate-300"
              >Select Timezone</label
            >
            <select
              id="timezone-select"
              class="bg-slate-700 text-slate-100 border border-slate-600 rounded p-2 focus:border-blue-500 focus:outline-none"
            >
              <option value="-43200">
                (GMT-12:00) International Date Line West
              </option>
              <option value="-39600">
                (GMT-11:00) Coordinated Universal Time-11
              </option>
              <option value="-36000">(GMT-10:00) Hawaii</option>
              <option value="-32400">(GMT-09:00) Alaska</option>
              <option value="-28800">
                (GMT-08:00) Pacific Time (US & Canada)
              </option>
              <option value="-25200">
                (GMT-07:00) Mountain Time (US & Canada)
              </option>
              <option value="-21600">
                (GMT-06:00) Central Time (US & Canada)
              </option>
              <option value="-18000">
                (GMT-05:00) Eastern Time (US & Canada)
              </option>
              <option value="-14400">(GMT-04:00) Atlantic Time (Canada)</option>
              <option value="-10800">(GMT-03:00) Buenos Aires</option>
              <option value="-7200">
                (GMT-02:00) Coordinated Universal Time-02
              </option>
              <option value="-3600">(GMT-01:00) Azores</option>
              <option value="0">(GMT+00:00) London, Dublin, Lisbon</option>
              <option value="3600">
                (GMT+01:00) Amsterdam, Berlin, Rome, Paris
              </option>
              <option value="7200">
                (GMT+02:00) Athens, Helsinki, Jerusalem
              </option>
              <option value="10800">(GMT+03:00) Moscow, St. Petersburg</option>
              <option value="12600">(GMT+03:30) Tehran</option>
              <option value="14400">(GMT+04:00) Abu Dhabi, Muscat</option>
              <option value="16200">(GMT+04:30) Kabul</option>
              <option value="18000">(GMT+05:00) Islamabad, Karachi</option>
              <option value="19800" selected>
                (GMT+05:30) India Standard Time (IST)
              </option>
              <option value="20700">(GMT+05:45) Kathmandu</option>
              <option value="21600">(GMT+06:00) Dhaka</option>
              <option value="25200">(GMT+07:00) Bangkok, Hanoi, Jakarta</option>
              <option value="28800">
                (GMT+08:00) Beijing, Perth, Singapore
              </option>
              <option value="32400">(GMT+09:00) Tokyo, Seoul, Osaka</option>
              <option value="34200">(GMT+09:30) Adelaide, Darwin</option>
              <option value="36000">(GMT+10:00) Sydney, Melbourne, Guam</option>
              <option value="39600">
                (GMT+11:00) Solomon Is., New Caledonia
              </option>
              <option value="43200">
                (GMT+12:00) Auckland, Wellington, Fiji
              </option>
            </select>
          </div>
        </div>
      </div>

      <div
        id="pwm-controls-container"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4"
      ></div>

      <details
        id="serial-monitor-details"
        class="bg-slate-800 rounded-lg p-4 shadow-lg border border-slate-700 mt-6"
      >
        <summary class="cursor-pointer text-lg font-semibold text-slate-100">
          Serial Monitor
        </summary>
        <div class="flex justify-between items-center mt-2">
          <button
            id="clear-log-button"
            class="bg-slate-700 hover:bg-slate-600 text-slate-200 font-medium py-1 px-2 rounded transition-colors border border-slate-600"
          >
            Clear Log
          </button>
        </div>

        <div
          id="log-container"
          class="mt-2 p-2 bg-slate-900 rounded h-64 overflow-y-scroll font-mono text-sm text-slate-300"
        ></div>
      </details>
    </div>

    <template id="channel-template">
      <div
        class="card bg-slate-800 rounded-lg p-6 shadow-lg border border-slate-700"
      >
        <div
          class="flex justify-between items-center border-b border-slate-700 pb-2 mb-4"
        >
          <h2 class="text-xl font-semibold text-slate-100 channel-name-display">
            Channel 1
          </h2>
          <button
            class="edit-channel-name text-slate-400 hover:text-blue-400 transition-colors"
            title="Edit channel name"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 edit-icon"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
              />
            </svg>
          </button>
        </div>
        <div class="main-controls">
          <div class="flex justify-between items-center mb-4">
            <label class="text-slate-300">Pin Name</label>
            <input
              type="text"
              placeholder="e.g., D1"
              class="pin-name bg-slate-700 text-slate-100 border border-slate-600 rounded p-2 focus:border-blue-500 focus:outline-none"
            />
          </div>
          <div class="flex justify-between items-center mb-4">
            <label class="text-slate-300">Brightness</label>
            <input
              type="range"
              min="0"
              max="100"
              value="100"
              class="brightness-slider w-[calc(100%-100px)] h-2 rounded appearance-none transition-opacity"
            />
            <span class="brightness-value text-blue-400 font-medium">100%</span>
          </div>
          <div class="flex justify-around items-center mb-4 gap-2">
            <button
              class="brightness-button bg-slate-700 hover:bg-slate-600 text-slate-200 font-medium py-2 px-4 rounded transition-colors border border-slate-600"
            >
              Dim 10%
            </button>
            <button
              class="brightness-button bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-2 px-4 rounded transition-colors"
            >
              Full 100%
            </button>
          </div>
          <div class="flex justify-between items-center mb-4">
            <label class="text-slate-300">Power</label>
            <label class="switch relative inline-block w-16 h-9">
              <input type="checkbox" class="led-toggle" />
              <span
                class="slider absolute cursor-pointer top-0 left-0 right-0 bottom-0 transition-all duration-400 rounded-full"
              ></span>
            </label>
          </div>
        </div>
        <fieldset
          class="scheduler-fieldset border border-slate-700 rounded p-4 mt-4"
        >
          <legend class="text-slate-200 text-base font-medium">
            Scheduler
          </legend>
          <div class="flex justify-between items-center mb-4">
            <label class="text-slate-300">Enable Schedule</label>
            <label class="switch relative inline-block w-16 h-9">
              <input type="checkbox" class="schedule-toggle" />
              <span
                class="slider absolute cursor-pointer top-0 left-0 right-0 bottom-0 transition-all duration-400 rounded-full"
              ></span>
            </label>
          </div>
          <div class="flex justify-between items-center mb-4">
            <label class="text-slate-300">On Time</label>
            <input
              type="time"
              disabled
              class="start-time bg-slate-700 text-slate-100 border border-slate-600 rounded p-2 disabled:bg-slate-800 disabled:opacity-50 focus:border-blue-500 focus:outline-none"
            />
          </div>
          <div class="flex justify-between items-center mb-4">
            <label class="text-slate-300">Off Time</label>
            <input
              type="time"
              disabled
              class="end-time bg-slate-700 text-slate-100 border border-slate-600 rounded p-2 disabled:bg-slate-800 disabled:opacity-50 focus:border-blue-500 focus:outline-none"
            />
          </div>
          <div class="flex justify-between items-center mb-4">
            <label class="text-slate-300">Scheduler Brightness</label>
            <input
              type="range"
              min="0"
              max="100"
              value="100"
              class="scheduler-brightness-slider w-[calc(100%-100px)] h-2 rounded appearance-none transition-opacity"
              disabled
            />
            <span class="scheduler-brightness-value text-blue-400 font-medium"
              >100%</span
            >
          </div>
          <div class="flex justify-around items-center mb-4 gap-2">
            <button
              class="scheduler-brightness-button bg-slate-700 hover:bg-slate-600 text-slate-200 font-medium py-2 px-4 rounded transition-colors border border-slate-600"
              disabled
            >
              Dim 10%
            </button>
            <button
              class="scheduler-brightness-button bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-2 px-4 rounded transition-colors"
              disabled
            >
              Full 100%
            </button>
          </div>
        </fieldset>
      </div>
    </template>

    <script>
      $(document).ready(() => {
        const $pinCountInput = $("#pin-count");
        const $pwmControlsContainer = $("#pwm-controls-container");
        const $timezoneSelect = $("#timezone-select");
        const $mDnsname = $("#mdns-name");
        const $channelTemplate = $("#channel-template");
        let isUpdating = false;
        let lastSentState = null;
        let lastConfirmedState = null;
        let statusPollInterval = null;
        let needsPolling = true;
        let scheduleCheckInterval = null;
        let nextScheduleCheck = null;
        let socket = null;
        let logPruneInterval = null;

        function areStatesEqual(state1, state2) {
          if (!state1 || !state2) return false;
          if (state1.gmt_offset !== state2.gmt_offset) return false;
          if (!state1.channels || !state2.channels) return false;
          if (state1.channels.length !== state2.channels.length) return false;
          return state1.channels.every((channel, index) => {
            const channel2 = state2.channels[index];
            return (
              channel.pin === channel2.pin &&
              channel.state === channel2.state &&
              channel.schedulerEnabled === channel2.schedulerEnabled &&
              channel.scheduler_start === channel2.scheduler_start &&
              channel.scheduler_end === channel2.scheduler_end &&
              channel.brightness === channel2.brightness &&
              channel.scheduler_brightness === channel2.scheduler_brightness
            );
          });
        }

        function updatePollingState() {
          const shouldPoll = !areStatesEqual(lastSentState, lastConfirmedState);
          if (shouldPoll && !statusPollInterval) {
            statusPollInterval = setInterval(updateStatus, 3000);
            needsPolling = true;
          } else if (!shouldPoll && statusPollInterval) {
            clearInterval(statusPollInterval);
            statusPollInterval = null;
            needsPolling = false;
          }
        }

        function updateSchedulerControls($card) {
          const $scheduleToggle = $card.find(".schedule-toggle");
          const $fieldset = $card.find(".scheduler-fieldset");
          $fieldset
            .find("input, select, button")
            .not(".schedule-toggle")
            .prop("disabled", !$scheduleToggle.prop("checked"));
        }

        function renderChannels(count) {
          $pwmControlsContainer.empty();
          if (!$channelTemplate.length) return;
          for (let i = 0; i < count; i++) {
            const $card = $($channelTemplate.html());
            $card.attr("data-index", i);
            $card.find(".channel-name-display").text(`Channel ${i + 1}`);
            $card.data("channelName", `Channel ${i + 1}`);
            $pwmControlsContainer.append($card);
            updateSchedulerControls($card);
          }
        }

        function showNotification(message, type = "success") {
          Toastify({
            text: message,
            duration: 3000,
            close: true,
            gravity: "bottom",
            position: "center",
            stopOnFocus: true,
            style: {
              background:
                type === "success"
                  ? "linear-gradient(to right, #10b981, #34d399)"
                  : "linear-gradient(to right, #ef4444, #f87171)",
            },
          }).showToast();
        }

        function calculateNextScheduleCheck() {
          const now = new Date();
          const activeSchedules = [];
          $(".card").each(function () {
            const $card = $(this);
            if (!$card.find(".schedule-toggle").prop("checked")) return;
            const startTime = $card.find(".start-time").val();
            const endTime = $card.find(".end-time").val();
            if (!startTime || !endTime) return;
            const [startHour, startMinute] = startTime.split(":").map(Number);
            const [endHour, endMinute] = endTime.split(":").map(Number);
            activeSchedules.push({ hour: startHour, minute: startMinute });
            activeSchedules.push({ hour: endHour, minute: endMinute });
          });
          if (activeSchedules.length === 0) {
            if (scheduleCheckInterval) {
              clearInterval(scheduleCheckInterval);
              scheduleCheckInterval = null;
            }
            return null;
          }
          const currentMinutes = now.getHours() * 60 + now.getMinutes();
          let nextCheckMinutes = Infinity;
          activeSchedules.forEach((schedule) => {
            const scheduleMinutes = schedule.hour * 60 + schedule.minute;
            if (
              scheduleMinutes > currentMinutes &&
              scheduleMinutes < nextCheckMinutes
            ) {
              nextCheckMinutes = scheduleMinutes;
            }
          });
          if (nextCheckMinutes === Infinity) {
            nextCheckMinutes = Math.min(
              ...activeSchedules.map((s) => s.hour * 60 + s.minute)
            );
            nextCheckMinutes += 24 * 60;
          }
          const nextCheck = new Date();
          nextCheck.setHours(Math.floor(nextCheckMinutes / 60));
          nextCheck.setMinutes(nextCheckMinutes % 60);
          nextCheck.setSeconds(0);
          if (nextCheckMinutes >= 24 * 60) {
            nextCheck.setDate(nextCheck.getDate() + 1);
          }
          nextCheck.setMinutes(nextCheck.getMinutes() - 1);
          return nextCheck;
        }

        function updateScheduleChecking() {
          const nextCheck = calculateNextScheduleCheck();
          if (!nextCheck) return;
          if (scheduleCheckInterval) {
            clearInterval(scheduleCheckInterval);
            scheduleCheckInterval = null;
          }
          const now = new Date();
          let timeUntilCheck = nextCheck.getTime() - now.getTime();
          if (timeUntilCheck <= 60000) {
            scheduleCheckInterval = setInterval(checkSchedules, 5000);
          } else {
            setTimeout(() => {
              checkSchedules();
              scheduleCheckInterval = setInterval(checkSchedules, 5000);
            }, timeUntilCheck);
          }
          nextScheduleCheck = nextCheck;
        }

        function checkSchedules() {
          const now = new Date();
          const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();
          $(".card").each(function () {
            const $card = $(this);
            const $scheduleToggle = $card.find(".schedule-toggle");
            const $mainControls = $card.find(".main-controls");
            if ($scheduleToggle.length && $scheduleToggle.prop("checked")) {
              const startTimeVal = $card.find(".start-time").val();
              const endTimeVal = $card.find(".end-time").val();
              if (startTimeVal && endTimeVal) {
                const [startHour, startMinute] = startTimeVal
                  .split(":")
                  .map(Number);
                const [endHour, endMinute] = endTimeVal.split(":").map(Number);
                const startTimeInMinutes = startHour * 60 + startMinute;
                const endTimeInMinutes = endHour * 60 + endMinute;
                let isWithinSchedule = false;
                if (startTimeInMinutes > endTimeInMinutes) {
                  isWithinSchedule =
                    currentTimeInMinutes >= startTimeInMinutes ||
                    currentTimeInMinutes < endTimeInMinutes;
                } else {
                  isWithinSchedule =
                    currentTimeInMinutes >= startTimeInMinutes &&
                    currentTimeInMinutes < endTimeInMinutes;
                }
                if (isWithinSchedule) {
                  $mainControls
                    .addClass("opacity-50 pointer-events-none")
                    .find("input, button")
                    .prop("disabled", true);
                } else {
                  $mainControls
                    .removeClass("opacity-50 pointer-events-none")
                    .find("input:not(.pin-name), button")
                    .prop("disabled", false);
                }
              }
            } else {
              $mainControls
                .removeClass("opacity-50 pointer-events-none")
                .find("input:not(.pin-name), button")
                .prop("disabled", false);
            }
          });
        }

        function debounce(func, wait) {
          let timeout;
          return function executedFunction(...args) {
            const later = () => {
              clearTimeout(timeout);
              func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
          };
        }

        async function sendSettings(settings) {
          try {
            lastSentState = settings;
            needsPolling = true;
            updatePollingState();
            await $.ajax({
              url: "/settings",
              method: "POST",
              contentType: "application/json",
              data: JSON.stringify(settings),
              success: () => {
                showNotification("Settings Applied Successfully!");
                //location.reload();
              },
              error: () =>
                showNotification("Failed to apply settings.", "error"),
            });
          } catch (error) {
            showNotification("Error: Could not reach server.", "error");
          }
        }
        const debouncedSendSettings = debounce(sendSettings, 200);

        async function updateStatus() {
          if (isUpdating || !needsPolling) return;
          try {
            isUpdating = true;
            const data = await $.getJSON("/status");
            lastConfirmedState = data;
            updatePollingState();
            const $allCards = $(".card");
            if (data.channels && data.channels.length !== $allCards.length) {
              $pinCountInput.val(data.channels.length);
              renderChannels(data.channels.length);
            }
            if (data.gmt_offset !== undefined) {
              $timezoneSelect.val(data.gmt_offset);
            }
            if (data.mDNSName !== undefined) {
              $mDnsname.val(data.mDNSName);
            }
            data.channels?.forEach((channel, i) => {
              const $card = $(".card").eq(i);
              if ($card.length) {
                if (channel.channelName) {
                  $card.find(".channel-name-display").text(channel.channelName);
                  $card.data("channelName", channel.channelName);
                }
                $card.find(".pin-name").val(channel.pin || "");
                $card.find(".led-toggle").prop("checked", channel.state);
                $card.find(".brightness-slider").val(channel.brightness);
                $card.find(".brightness-value").text(`${channel.brightness}%`);
                $card
                  .find(".schedule-toggle")
                  .prop("checked", channel.schedulerEnabled);
                $card.find(".start-time").val(channel.scheduler_start || "");
                $card.find(".end-time").val(channel.scheduler_end || "");
                $card
                  .find(".scheduler-brightness-slider")
                  .val(channel.scheduler_brightness || 100);
                $card
                  .find(".scheduler-brightness-value")
                  .text(`${channel.scheduler_brightness || 100}%`);
                updateSchedulerControls($card);
              }
            });
          } catch (error) {
            console.error("Error fetching status:", error);
          } finally {
            isUpdating = false;
          }
        }

        function buildPayload() {
          if (isUpdating) return;
          const payload = {
            channels: $(".card")
              .map((i, card) => {
                const $card = $(card);
                return {
                  pin: $card.find(".pin-name").val(),
                  channelName: $card.find(".channel-name-display").text(),
                  state: $card.find(".led-toggle").prop("checked"),
                  schedulerEnabled: $card
                    .find(".schedule-toggle")
                    .prop("checked"),
                  scheduler_start: $card.find(".start-time").val(),
                  scheduler_end: $card.find(".end-time").val(),
                  brightness: parseInt($card.find(".brightness-slider").val()),
                  scheduler_brightness: parseInt(
                    $card.find(".scheduler-brightness-slider").val()
                  ),
                };
              })
              .get(),
            gmt_offset: parseInt($timezoneSelect.val()),
            mDNSName: $mDnsname.val().trim(),
          };
          debouncedSendSettings(payload);
        }

        $pinCountInput.on("change", () => {
          renderChannels(parseInt($pinCountInput.val()));
          buildPayload();
        });

        $timezoneSelect.on("change", buildPayload);
        $mDnsname.on("change", buildPayload);

        $pwmControlsContainer.on("input", "input", (e) => {
          if (
            e.target.classList.contains("start-time") ||
            e.target.classList.contains("end-time")
          ) {
            updateScheduleChecking();
          }
          const $target = $(e.target);
          const $card = $target.closest(".card");
          if ($target.hasClass("brightness-slider")) {
            $card.find(".brightness-value").text(`${$target.val()}%`);
          } else if ($target.hasClass("scheduler-brightness-slider")) {
            $card.find(".scheduler-brightness-value").text(`${$target.val()}%`);
          } else if (e.target.classList.contains("schedule-toggle")) {
            updateSchedulerControls($card);
            updateScheduleChecking();
          }
          buildPayload();
        });

        $pwmControlsContainer.on(
          "click",
          ".brightness-button, .scheduler-brightness-button",
          function () {
            const $card = $(this).closest(".card");
            const isDimButton = $(this).text().includes("Dim");
            const value = isDimButton ? 10 : 100;
            const sliderClass = $(this).hasClass("scheduler-brightness-button")
              ? "scheduler-brightness-slider"
              : "brightness-slider";
            const valueClass = $(this).hasClass("scheduler-brightness-button")
              ? "scheduler-brightness-value"
              : "brightness-value";
            const $slider = $card.find(`.${sliderClass}`);
            $slider.val(value);
            $card.find(`.${valueClass}`).text(`${value}%`);
            buildPayload();
          }
        );

        $pwmControlsContainer.on("click", ".edit-channel-name", function () {
          const $card = $(this).closest(".card");
          const $nameDisplay = $card.find(".channel-name-display");
          const currentName = $nameDisplay.text();
          const channelIndex = parseInt($card.attr("data-index"));
          const newName = prompt("Enter new channel name:", currentName);
          if (
            newName !== null &&
            newName.trim() !== "" &&
            newName !== currentName
          ) {
            $nameDisplay.text(newName.trim());
            $card.data("channelName", newName.trim());
            buildPayload();
          }
        });

        async function updateVersion() {
          try {
            const data = await $.getJSON("/version");
            if (data.version) {
              $("#version-display").text(`v${data.version}`);
            }
          } catch (error) {
            console.error("Error fetching version:", error);
          }
        }

        function pruneLogs() {
          const logContainer = document.getElementById("log-container");
          const fiveMinutesAgo = Date.now() - 5 * 60 * 1000;
          const logEntries = logContainer.querySelectorAll(
            "div[data-timestamp]"
          );
          logEntries.forEach((entry) => {
            if (parseInt(entry.dataset.timestamp) < fiveMinutesAgo) {
              entry.remove();
            }
          });
        }

        function connectWebSocket() {
          if (socket && socket.readyState === WebSocket.OPEN) {
            console.log("WebSocket is already connected.");
            return;
          }
          const logContainer = document.getElementById("log-container");
          socket = new WebSocket(`ws://${window.location.hostname}:81/`);

          socket.onopen = function () {
            console.log("WebSocket connection established");
            logContainer.innerHTML +=
              '<div class="text-green-400">[WS] Connection established</div>';
            if (!logPruneInterval) {
              logPruneInterval = setInterval(pruneLogs, 10000); // Check every 10 seconds
            }
          };

          socket.onmessage = function (event) {
            const isScrolledToBottom =
              logContainer.scrollHeight - logContainer.clientHeight <=
              logContainer.scrollTop + 1;
            const logEntry = document.createElement("div");
            logEntry.dataset.timestamp = Date.now();
            logEntry.innerHTML = event.data.replace(/\n/g, "<br>");
            logContainer.appendChild(logEntry);
            if (isScrolledToBottom) {
              logContainer.scrollTop = logContainer.scrollHeight;
            }
          };

          socket.onclose = function () {
            console.log("WebSocket connection closed.");
            logContainer.innerHTML +=
              '<div class="text-red-400">[WS] Connection closed.</div>';
            if (logPruneInterval) {
              clearInterval(logPruneInterval);
              logPruneInterval = null;
            }
          };

          socket.onerror = function (error) {
            console.error("WebSocket Error:", error);
            logContainer.innerHTML += `<div class="text-red-500">[WS] Error: ${error.message}</div>`;
          };
        }

        function disconnectWebSocket() {
          if (socket) {
            socket.onclose = null; // prevent reconnection
            socket.close();
            socket = null;
            $("#log-container").append(
              '<div class="text-yellow-400">[WS] Connection closed by user.</div>'
            );
            if (logPruneInterval) {
              clearInterval(logPruneInterval);
              logPruneInterval = null;
            }
          }
        }

        $("#clear-log-button").on("click", function () {
          $("#log-container").empty();
        });

        $("#serial-monitor-details").on("toggle", function () {
          if ($(this).prop("open")) {
            connectWebSocket();
          } else {
            disconnectWebSocket();
          }
        });

        renderChannels(parseInt($pinCountInput.val()));
        updateStatus();
        updatePollingState();
        checkSchedules();
        updateScheduleChecking();
        updateVersion();
      });
    </script>
  </body>
</html>
