<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF--8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container my-4">
        <div class="card bg-dark-subtle text-light">
            <div class="card-header text-center">
                <h2>LED Light Bar Control</h2>
            </div>
            <div class="card-body">
                <div class="mb-4 text-center">
                    <div class="form-check form-switch d-inline-block">
                        <input class="form-check-input" type="checkbox" role="switch" id="ledStateSwitch">
                        <label class="form-check-label" for="ledStateSwitch" id="ledStateLabel">LED is OFF</label>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="brightnessSlider" class="form-label">Brightness: <span id="brightnessValue">0</span></label>
                    <input type="range" class="form-range" id="brightnessSlider" min="0" max="255" step="1">
                </div>

                <hr>
                <div class="mt-4">
                    <h4 class="text-center mb-3">Timer Settings</h4>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" role="switch" id="timerEnabledSwitch">
                        <label class="form-check-label" for="timerEnabledSwitch">Enable Timer</label>
                    </div>
                    <div id="timerControls" class="d-none">
                        <div class="row g-3 align-items-center">
                            <div class="col-auto">
                                <label for="onTime" class="col-form-label">ON Time</label>
                            </div>
                            <div class="col">
                                <input type="time" id="onTime" class="form-control">
                            </div>
                            <div class="col-auto">
                                <label for="offTime" class="col-form-label">OFF Time</label>
                            </div>
                            <div class="col">
                                <input type="time" id="offTime" class="form-control">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const gateway = `ws://${window.location.hostname}/ws`;
        let websocket;

        // UI Elements
        const ledStateSwitch = document.getElementById('ledStateSwitch');
        const ledStateLabel = document.getElementById('ledStateLabel');
        const brightnessSlider = document.getElementById('brightnessSlider');
        const brightnessValue = document.getElementById('brightnessValue');
        const timerEnabledSwitch = document.getElementById('timerEnabledSwitch');
        const timerControls = document.getElementById('timerControls');
        const onTimeInput = document.getElementById('onTime');
        const offTimeInput = document.getElementById('offTime');

        window.addEventListener('load', onLoad);

        function onLoad() {
            initWebSocket();
        }

        function initWebSocket() {
            console.log('Trying to open a WebSocket connection...');
            websocket = new WebSocket(gateway);
            websocket.onopen = onOpen;
            websocket.onclose = onClose;
            websocket.onmessage = onMessage;
        }

        function onOpen(event) {
            console.log('Connection opened');
        }

        function onClose(event) {
            console.log('Connection closed');
            setTimeout(initWebSocket, 2000);
        }

        function sendData(data) {
            websocket.send(JSON.stringify(data));
        }

        function onMessage(event) {
            console.log(event.data);
            const data = JSON.parse(event.data);

            // Update LED State
            ledStateSwitch.checked = data.state;
            ledStateLabel.textContent = data.state ? 'LED is ON' : 'LED is OFF';
            brightnessSlider.disabled = !data.state;

            // Update Brightness
            brightnessSlider.value = data.brightness;
            brightnessValue.textContent = data.brightness;

            // Update Timer
            timerEnabledSwitch.checked = data.timerEnabled;
            if (data.timerEnabled) {
                timerControls.classList.remove('d-none');
            } else {
                timerControls.classList.add('d-none');
            }
            onTimeInput.value = data.onTime;
            offTimeInput.value = data.offTime;
        }

        // Event Listeners
        ledStateSwitch.addEventListener('change', () => {
            sendData({ state: ledStateSwitch.checked });
        });

        brightnessSlider.addEventListener('input', () => {
            brightnessValue.textContent = brightnessSlider.value;
        });

        brightnessSlider.addEventListener('change', () => {
            sendData({ brightness: parseInt(brightnessSlider.value) });
        });

        timerEnabledSwitch.addEventListener('change', () => {
            sendData({ timerEnabled: timerEnabledSwitch.checked });
        });

        onTimeInput.addEventListener('change', () => {
            sendData({ onTime: onTimeInput.value });
        });

        offTimeInput.addEventListener('change', () => {
            sendData({ offTime: offTimeInput.value });
        });

    </script>
</body>
</html>